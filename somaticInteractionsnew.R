#' Exact tests to detect mutually exclusive, co-occuring and altered genesets.
#'
#' @description Performs Pair-wise Fisher's Exact test to detect mutually exclusive or co-occuring events.
#' @details This function and plotting is inspired from genetic interaction analysis performed in the published study combining gene expression and mutation data in MDS. See reference for details.
#' @references Gerstung M, Pellagatti A, Malcovati L, et al. Combining gene mutation with gene expression data improves outcome prediction in myelodysplastic syndromes. Nature Communications. 2015;6:5901. doi:10.1038/ncomms6901.
#' @param maf an \code{\link{MAF}} object generated by \code{\link{read.maf}}
#' @param top check for interactions among top 'n' number of genes. Defaults to top 25. \code{genes}
#' @param genes List of genes among which interactions should be tested. If not provided, test will be performed between top 25 genes.
#' @param geneOrder Plot the results in given order. Default NULL.
#' @param pvalue Default c(0.05, 0.01) p-value threshold. You can provide two values for upper and lower threshold.
#' @param returnAll If TRUE returns test statistics for all pair of tested genes. Default FALSE, returns for only genes below pvalue threshold.
#' @param fontSize cex for gene names. Default 0.8
#' @param showSigSymbols Default TRUE. Heighlight significant pairs
#' @param showCounts Default TRUE. Include number of events in the plot
#' @param countStats Default `all`. Can be `all` or `sig`
#' @param countType Default `cooccur`. Can be `all`, `cooccur`, `mutexcl`
#' @param countsFontSize Default 0.8
#' @param countsFontColor Default `black`
#' @param colPal colPalBrewer palettes. See RColorBrewer::display.brewer.all() for details
#'
#' @examples
#' laml.maf <- system.file("extdata", "tcga_laml.maf.gz", package = "maftools")
#' laml <- read.maf(maf = laml.maf)
#' somaticInteractions(maf = laml, top = 5)
#' @return list of data.tables
#' @export

somaticInteractionsnew = function(maf, top = 25, genes = NULL, pvalue = c(0.05, 0.01), returnAll = TRUE,
                                  geneOrder = NULL, fontSize = 0.8, showSigSymbols = TRUE,
                                  showCounts = FALSE, countStats = 'sig', countType = 'all',
                                  countsFontSize = 0.8, countsFontColor = "black", colPal = "BrBG"){
  
  # maf = lamlDiagnosisPediatric
  # genes=recurrent_genes
  # pvalue = c(0.05, 0.1)
  # fontSize=1.5
  # returnAll = TRUE
  # showSigSymbols = TRUE
  # showCounts = FALSE
  # countStats = 'sig'
  # countType = 'all'
  # countsFontSize = 0.8
  # countsFontColor = "black"
  # colPal = "BrBG"

  if(is.null(genes)){
    genes = getGeneSummary(x = maf)[1:top, Hugo_Symbol]
  }
  
  if(length(genes) < 2){
    stop("Minimum two genes required!")
  }
  
  om = createOncoMatrix(m = maf, g = genes)
  all.tsbs = levels(getSampleSummary(x = maf)[,Tumor_Sample_Barcode])
  
  mutMat = t(om$numericMatrix)
  mutMattemp=mutMat
  #View(mutMat)
  #mutMat=mutMat[,which(colSums(mutMat)>=3)]
  missing.tsbs = all.tsbs[!all.tsbs %in% rownames(mutMat)]
  
  if(nrow(mutMat) < 2){
    stop("Minimum two genes required!")
  }
  mutMat[mutMat > 0 ] = 1
  
  if(length(missing.tsbs) > 0){
    missing.tsbs = as.data.frame(matrix(data = 0, nrow = length(missing.tsbs), ncol = ncol(mutMat)),
                                 row.names = missing.tsbs)
    colnames(missing.tsbs) = colnames(mutMat)
    mutMat = rbind(mutMat, missing.tsbs)
  }
  
  #pairwise fisher test source code borrowed from: https://www.nature.com/articles/ncomms6901
  interactions = sapply(1:ncol(mutMat), function(i) sapply(1:ncol(mutMat), function(j) {f<- try(fisher.test(mutMat[,i], mutMat[,j]), silent=TRUE); if(class(f)=="try-error") NA else ifelse(f$estimate>1, -log10(f$p.val),log10(f$p.val))} ))
  oddsRatio <- oddsGenes <- sapply(1:ncol(mutMat), function(i) sapply(1:ncol(mutMat), function(j) {f<- try(fisher.test(mutMat[,i], mutMat[,j]), silent=TRUE); if(class(f)=="try-error") f=NA else f$estimate} ))
  rownames(interactions) = colnames(interactions) = rownames(oddsRatio) = colnames(oddsRatio) = colnames(mutMat)

  
  sigPairs = which(x = 10^-abs(interactions) < 1, arr.ind = TRUE)
  sigPairs2 = which(x = 10^-abs(interactions) >= 1, arr.ind = TRUE)
  #return(list(interactions, sigPairs))
  
  if(nrow(sigPairs) < 1){
    stop("No meaningful interactions found.")
  }
  
  sigPairs = rbind(sigPairs, sigPairs2)
  sigPairsTbl = data.table::rbindlist(
    lapply(X = seq_along(1:nrow(sigPairs)), function(i) {
      x = sigPairs[i,]
      g1 = rownames(interactions[x[1], x[2], drop = FALSE])
      g2 = colnames(interactions[x[1], x[2], drop = FALSE])
      tbl = as.data.frame(table(apply(X = mutMat[,c(g1, g2), drop = FALSE], 1, paste, collapse = "")))
      combn = data.frame(t(tbl$Freq))
      colnames(combn) = tbl$Var1
      pval = 10^-abs(interactions[x[1], x[2]])
      fest = oddsRatio[x[1], x[2]]
      d = data.table::data.table(gene1 = g1,
                                 gene2 = g2,
                                 pValue = pval, oddsRatio = fest)
      d = cbind(d, combn)
      d
    }), fill = TRUE)
  
  sigPairsTbl = sigPairsTbl[!gene1 == gene2] #Remove doagonal elements
  sigPairsTbl[is.na(sigPairsTbl)] = 0
  sigPairsTbl$Event = ifelse(test = sigPairsTbl$oddsRatio > 1, yes = "Co_Occurence", no = "Mutually_Exclusive")
  sigPairsTbl$pair = apply(X = sigPairsTbl[,.(gene1, gene2)], MARGIN = 1, FUN = function(x) paste(sort(unique(x)), collapse = ", "))
  sigPairsTbl[,event_ratio := `01`+`10`]
  sigPairsTbl[,event_ratio := paste0(`11`, '/', event_ratio)]
  sigPairsTblSig = sigPairsTbl[order(as.numeric(pValue))][!duplicated(pair)]
  
  #Source code borrowed from: https://www.nature.com/articles/ncomms6901
  if(nrow(interactions) >= 5){
    #interactions[10^-abs(interactions) > max(pvalue)] = 0
    diag(interactions) <- 0
    m <- nrow(interactions)
    n <- ncol(interactions)
    
    col_pal = RColorBrewer::brewer.pal(9, colPal)
    col_pal = grDevices::colorRampPalette(colors = col_pal)
    col_pal = col_pal(n*m)
    
    #interactions[interactions < -4] = -4
    #interactions[interactions > 4] = 4
    
    if(!is.null(geneOrder)){
      if(!all(rownames(interactions) %in% geneOrder)){
        stop("Genes in geneOrder does not match the genes used for analysis.")
      }
      interactions = interactions[geneOrder, geneOrder]
    }
  
    temp=interactions
    temp[lower.tri(x = temp, diag = TRUE)] = 0
  #  View(temp)
    #interactions=scale(interactions)
    interactions[lower.tri(x = interactions, diag = TRUE)] = NA
   # View(interactions)
   # temp= interactions
  #  interactions=interactions[which(!is.na(interactions),arr.ind = TRUE)]=scale(interactions[!is.na(interactions)])
    
    
    gene_sum = getGeneSummary(x = maf)[Hugo_Symbol %in% rownames(interactions), .(Hugo_Symbol, MutatedSamples)]
    data.table::setDF(gene_sum, rownames = gene_sum$Hugo_Symbol)
    gene_sum = gene_sum[rownames(interactions),]
    if(!all(rownames(gene_sum) == rownames(interactions))){
      stop(paste0("Row mismatches!"))
    }
    if(!all(rownames(gene_sum) == colnames(interactions))){
      stop(paste0("Column mismatches!"))
    }
    rownames(gene_sum) = paste0(apply(gene_sum, 1, paste, collapse = ' ['), ']')
    
    par(bty="n", mar = c(4, 12, 12, 1)+.1, las=2, fig = c(0, 1, 0, 1))
    # par(bty="n", mgp = c(2,.5,0), mar = c(2, 9, 4, 7)+.1, las=2, tcl=-.33)
    #View(temp)
  #  temp=scale(temp,scale=FALSE)
    rows=rownames(temp)
    cols=colnames(temp)
    temp=matrix(rescale((temp),to=c(-1,1)),nrow=length(rows),ncol=length(cols))
    rownames(temp)=rows
    colnames(temp)=cols
   # View(temp)
    temp[lower.tri(x = temp, diag = TRUE)] = NA
    print(min(interactions[!is.na(temp)]))
    print(max(interactions[!is.na(temp)]))
   # View(temp)
  #  View(interactions)
   # View(temp)
   # View(interactions)
    #temp=temp[lower.tri(x = interactions, diag = TRUE)] = 0
    #View(interactions)
  #  temp=interactions[mutations,mutations]
    #View(temp)
   # n1=nrow(temp)
  #  m1=ncol(temp)
  hello=image(x=1:n, y=1:m,z=interactions, col = col_pal,
          xaxt="n", yaxt="n",
          xlab="",ylab="", xlim=c(0, n+1), ylim=c(0, n+1),zlim=c(-4,4))
    abline(h=0:n+.5, col="white", lwd=.5)
    abline(v=0:n+.5, col="white", lwd=.5)
    
    mtext(side = 2, at = 1:m, text = rownames(gene_sum), cex = fontSize, font = 3)
    mtext(side = 3, at = 1:n, text = rownames(gene_sum), cex = fontSize, font = 3)
    #text(x = 1:m, y = rep(n+0.5, length(n)), labels = rownames(gene_sum), srt = 90, adj = 0, font = 3, cex = fontSize)
    
    #View(hello)
    if(showCounts){
      countStats = match.arg(arg = countStats, choices = c("all", "sig"))
      countType = match.arg(arg = countType, choices = c("all", "cooccur", "mutexcl"))
      
      if(countStats == 'sig'){
        w = arrayInd(which(10^-abs(interactions) < max(pvalue)), rep(m,2))
        for(i in 1:nrow(w)){
          g1 = rownames(interactions)[w[i, 1]]
          g2 = colnames(interactions)[w[i, 2]]
          g12 = paste(sort(c(g1, g2)), collapse = ', ')
          if(countType == 'all'){
            e = sigPairsTblSig[pValue < max(pvalue)][pair %in% g12, event_ratio]
          }else if(countType == 'cooccur'){
            e = sigPairsTblSig[pValue < max(pvalue)][Event %in% "Co_Occurence"][pair %in% g12, `11`]
          }else if(countType == 'mutexcl'){
            e = sigPairsTblSig[pValue < max(pvalue)][Event %in% "Mutually_Exclusive"][pair %in% g12, `11`]
          }
          if(length(e) == 0){
            e = 0
          }
          text(w[i,1], w[i,2], labels = e, font = 3, col = countsFontColor, cex = countsFontSize)
        }
      }else if(countStats == 'all'){
        w = arrayInd(which(10^-abs(interactions) < max(pvalue)), rep(m,2))
        w2 = arrayInd(which(10^-abs(interactions) >= max(pvalue)), rep(m,2))
        w = rbind(w, w2)
        #print(w)
        for(i in 1:nrow(w)){
          g1 = rownames(interactions)[w[i, 1]]
          g2 = colnames(interactions)[w[i, 2]]
          g12 = paste(sort(c(g1, g2)), collapse = ', ')
          if(countType == 'all'){
            e = sigPairsTblSig[pair %in% g12, event_ratio]
          }else if(countType == 'cooccur'){
            e = sigPairsTblSig[pair %in% g12, `11`]
          }else if(countType == 'mutexcl'){
            e = sigPairsTblSig[pair %in% g12, `01` + `10`]
          }
          if(length(e) == 0){
            e = 0
          }
          text(w[i,1], w[i,2], labels = e, font = 3, col = countsFontColor, cex = countsFontSize)
        }
      }
    }
    
    if(showSigSymbols){
      w = arrayInd(which(10^-abs(interactions) < min(pvalue)), rep(m,2))
      points(w, pch="*", col="black",cex = 1.5)
      w = arrayInd(which(10^-abs(interactions) < max(pvalue)), rep(m,2))
      points(w, pch=".", col="black",cex = 5)
    }
    
    if(showSigSymbols){
      points(x = n-2, y = 0.7*n, pch = "*", cex = 2)
      text(x = n-2, y = 0.7*n, paste0("P < ", min(pvalue)), pos=4, cex = 1.5, adj = 0)
      points(x = n-2, y = 0.65*n, pch = ".", cex = 5)
      text(x = n-2, y = 0.65*n, paste0("P < ", max(pvalue)), pos=4, cex = 1.5)
    }
    
    #image(y = 1:8 +6, x=rep(n,2)+c(2,2.5)+1, z=matrix(c(1:8), nrow=1), col=brewer.pal(8,"PiYG"), add=TRUE)
    
    par(fig = c(0.4, 0.7, 0, 0.6), new = TRUE)
    image(
      x = c(0.8, 1),
      y = seq(0, 4, length.out = 200),
      z = matrix(seq(-1,1,length.out = 200), nrow = 1),
      col = col_pal, xlim = c(0, 1), ylim = c(0, 4), axes = FALSE, xlab = NA, ylab = NA
    )
    
    #atLims = seq(nrow(interactions), 0.9*nrow(interactions), length.out = 7)
    # atLims = seq(0, 1, length.out = 7)
    # axis(side = 4, at = atLims,  tcl=-.15, labels =c("3", 2, 1, 0, 1, 2, "3"), lwd=1, cex.axis = 0.8, line = 0.2)
    # text(x = 0.4, y = 0.5, labels = "-log10(P-value)", srt = 90)
    # text(x=0.4, y=0.9, labels = "Co-occurrence", font = 1)
    # text(x=0.8, y = -0.1, labels="Mutual Exclusion", font = 1)
    # 
    
    atLims = seq(0, 4, length.out = 9)
    axis(side = 4, at = atLims, tcl=-.15, labels =c("4",3, 2, 1, 0, 1, 2,3,"4" ),lwd=2, cex.axis=1.5,cex.main = 1.5, cex.lab = 1.5, cex.sub = 1.5,lheight=10, line = 1.5)
    mtext(side=4, at = median(atLims), "-log10 (p-value)", las=3, cex = 1.5, line = 4, font = 1)
    
    par(xpd=NA)
    text(x=0.5, y= max(atLims)+0.3, "Co-occurrence", pos=4, cex = 1.5, font = 1)
    text(x=0.5, y = min(atLims)-0.3, "Mutual Exclusion", pos=4, cex = 1.5, font = 1)
    
    #mtext(side=4, at = median(atLims), "-log10 (p-value)", las=3, cex = 0.9, line = 2.5, font = 1)
    
    
    
  }
  
  if(!returnAll){
    sigPairsTblSig = sigPairsTblSig[pValue < min(pvalue)]
  }
  return(sigPairsTblSig)
}